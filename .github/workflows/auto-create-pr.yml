name: Auto Create PR

on:
  push:
    branches:
      - "**"

jobs:
  create-pr:
    name: Create PR for new branch
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get default branch
        id: default
        run: |
          default=$(gh repo view --json defaultBranchRef -q .defaultBranchRef.name)
          echo "branch=$default" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN != '' && secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Skip if default branch
        id: skip
        run: |
          current="${GITHUB_REF#refs/heads/}"
          echo "current=$current" >> $GITHUB_OUTPUT
          if [ "$current" = "${{ steps.default.outputs.branch }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Create PR
        id: create-pr
        if: steps.skip.outputs.skip == 'false'
        run: |
          branch="${GITHUB_REF#refs/heads/}"
          if gh pr view --head "$branch" 2>/dev/null; then
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "PR already exists for this branch, skipping create."
            exit 0
          fi
          echo "pr_exists=false" >> $GITHUB_OUTPUT
          title=$(git log -1 --pretty=format:"%s")
          body=$(git log -1 --pretty=format:"%b")
          if [ -z "$body" ]; then
            body="Auto-created PR for branch \`$branch\`."
          fi
          gh pr create \
            --base "${{ steps.default.outputs.branch }}" \
            --head "$branch" \
            --title "$title" \
            --body "$body"
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN != '' && secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Run reviewdog (Ruff) on PR
        if: steps.skip.outputs.skip == 'false'
        uses: benny123tw/action-ruff@v1
        with:
          github_token: ${{ secrets.GH_TOKEN != '' && secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          reporter: github-pr-review
          fail_level: warning
